<html>
    <head>
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="../book.css" type="text/css" />
        <title>UDIG Developer Guide : 1 Actions</title>
    </head>
    <body BGCOLOR="#FFFFFF">
       <!-- UDIG Developer Guide : 1 Actions -->
       <h1>1 Actions</h1>

       <p>The default wizard provided by eclipse will let you add to the top-level toolbar or menu system using the concept of Actions and ActionSets.</p>

<h3><a name="1Actions-Option1%3AAction"></a>Option 1: Action</h3>

<p>You can use action directly - this is an acceptable approach if you are going to use the action within your plugin.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">newAction = <span class="code-keyword">new</span> Action(<span class="code-quote">"New..."</span>) {
    <span class="code-keyword">public</span> void run() { 
        registerDatasource();
    }
};
newAction.setImageDescriptor(getImageDescriptor(<span class="code-quote">"<span class="code-keyword">new</span>.gif"</span>));</pre>
</div></div>
<p>Example use with a toolbar:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">IToolBarManager mgr = getViewSite().getActionBars().getToolBarManager();
mgr.add( newAction );</pre>
</div></div>

<h3><a name="1Actions-Contributingactionsviaactionsets"></a>Contributing actions via action sets</h3>
<p>An action set is a mechanism that allows a plug-in to contribute menus, menu items, and toolbar items to the main menu bar and toolbar of the Workbench window. It is important to understand what action sets are meant to be used for. An action set should contribute common actions which are not specific to any particular view or editor. <br/>
The class defined in the plugin ActionSets extension point must implement org.eclipse.ui.IWorkbenchWindowActionDelegate interface if the pulldown attribute is false, or org.eclipse.ui.IWorkbenchWindowPulldownDelegate interface if the pulldown attribute is true. This delegate class can control the enabled/disabled state of the action when the selection changes, but only once the plug-in is loaded. Until then, the enabled/disabled state of the action is controlled by other XML attributes like enablesFor and selection. </p>


<h3><a name="1Actions-WorkbenchandActions"></a>Workbench and Actions</h3>

<p>Uses IWorkbenchWindowActionDelegate ...</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">public</span> class EditStyleAction <span class="code-keyword">implements</span> IWorkbenchWindowActionDelegate {

    <span class="code-keyword">public</span> <span class="code-keyword">final</span> <span class="code-keyword">static</span> <span class="code-object">String</span> ID = <span class="code-quote">"net.refractions.udig.style.openStyleEditorAction"</span>; <span class="code-comment">//$NON-NLS-1$
</span>    
    <span class="code-keyword">private</span> Layer selectedLayer;
    
    <span class="code-keyword">public</span> void dispose() {
    }

    <span class="code-keyword">public</span> void init( IWorkbenchWindow window ) {
        
    }

    <span class="code-keyword">public</span> void run( IAction action ) {
        Display.getDefault().asyncExec(<span class="code-keyword">new</span> <span class="code-object">Runnable</span>(){
            <span class="code-keyword">public</span> void run() {
                StyleView styleView = <span class="code-keyword">null</span>;
                <span class="code-keyword">try</span> {
                    IWorkbenchPage page  = PlatformUI.getWorkbench().getActiveWorkbenchWindow().getActivePage();
                    page.showView( StyleView.VIEW_ID );
                    
                    styleView = (StyleView) 
                    <span class="code-keyword">if</span> (selectedLayer != <span class="code-keyword">null</span>);
                        styleView.setSelectedLayer(selectedLayer);
                } 
                <span class="code-keyword">catch</span> (PartInitException e2) {
                    e2.printStackTrace(); 
                }
            }
        });
    }

    <span class="code-keyword">public</span> void selectionChanged( IAction action, ISelection selection ) {
        <span class="code-keyword">if</span> (selection.isEmpty() || !(selection <span class="code-keyword">instanceof</span> IStructuredSelection)) 
            <span class="code-keyword">return</span>;
        
        StructuredSelection sselection = (StructuredSelection)selection;
        <span class="code-keyword">if</span> (sselection.getFirstElement() <span class="code-keyword">instanceof</span> Layer) {
            selectedLayer = (Layer)sselection.getFirstElement();
        }
    }    
}</pre>
</div></div>

<h3><a name="1Actions-ViewandActions"></a>View and Actions</h3>

<p>Uses IViewActionDelegate ...<br/>
The interface IViewActionDelegate allows the action delegate, during initialization, to target itself with the view instance it should work with.<br/>
The action delegate must implement the method setActiveEditor(IAction action, IEditorPart targetEditor).<br/>
Action enablement is declared in XML because plug-ins are loaded lazily. Until an action is actually invoked by the user, the plug-in is not loaded and the Workbench uses the enablement logic declared in XML. Once a plug-in is loaded, the delegate class is notified of selection changes and can update the enabled/disabled state of the action. Refer to the org.eclipse.ui.IActionDelegate.selectionChanged(IAction action, ISelection selection) method documentation for more details. </p>

<h4><a name="1Actions-ViewContextMenu"></a>View Context Menu</h4>
<p>The class defined for the action must implement org.eclipse.ui.IViewActionDelegate interface if contributing to a view's context menu.</p>

<p>EnablesFor attribute control the enabled/disabled state of the action based on the current selection. Its value is the selection count condition which must be met to enable the action. If not the action is disabled. If attribute is skipped default is enable for any number of items selected.</p>

<table class='confluenceTable'><tbody>
<tr>
<th class='confluenceTh'>Formats </th>
<td class='confluenceTd'> Description </td>
</tr>
<tr>
<td class='confluenceTd'>! </td>
<td class='confluenceTd'> 0 items selected </td>
</tr>
<tr>
<td class='confluenceTd'>? </td>
<td class='confluenceTd'> 0 or 1 items selected </td>
</tr>
<tr>
<td class='confluenceTd'>+ </td>
<td class='confluenceTd'> 1 or more items selected </td>
</tr>
<tr>
<td class='confluenceTd'>multiple, 2+ </td>
<td class='confluenceTd'> 2 or more items selected </td>
</tr>
<tr>
<td class='confluenceTd'>n </td>
<td class='confluenceTd'> a precise number of items selected (e.g. 4) </td>
</tr>
<tr>
<td class='confluenceTd'><ul>
	<li></li>
</ul>
</td>
<td class='confluenceTd'> any number of items selected </td>
</tr>
</tbody></table>

<p>Here is an example used in udig with the zoom to layer action in the Layers View.<br/>
Create an object contribution to ILayer class and add the zoom to layer action to your plugin.</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">&lt;objectContribution
            adaptable=<span class="code-quote">"<span class="code-keyword">false</span>"</span>
            objectClass=<span class="code-quote">"net.refractions.udig.project.ILayer"</span>
            id=<span class="code-quote">"net.refractions.udig.project.ui.LayerContribution"</span>&gt;
       &lt;action
               label=<span class="code-quote">"%zoomToLayer.label"</span>
               icon=<span class="code-quote">"icons/elcl16/zoom_layer_co.gif"</span>
               tooltip=<span class="code-quote">"%zoomToLayer.tooltip"</span>
               class=<span class="code-quote">"net.refractions.udig.project.ui.internal.actions.ZoomToLayer"</span>
               style=<span class="code-quote">"push"</span>
               id=<span class="code-quote">"net.refractions.udig.project.ui.zoomTo"</span>/&gt;
      &lt;/objectContribution&gt;</pre>
</div></div>

<p>Then create the ZoomToLayer class that implements IViewActionDelegate </p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">public</span> class ZoomToLayer <span class="code-keyword">extends</span> ActionDelegate <span class="code-keyword">implements</span> IViewActionDelegate {
    IStructuredSelection selection;

    <span class="code-keyword">public</span> void selectionChanged( IAction action, ISelection selection ) {
        <span class="code-keyword">try</span>{
        <span class="code-keyword">this</span>.selection=(IStructuredSelection) selection;
        }<span class="code-keyword">catch</span> (Exception e) { <span class="code-comment">//<span class="code-keyword">do</span> nothing
</span>        }
    }

    <span class="code-keyword">public</span> void runWithEvent( IAction action, Event event ) {
        <span class="code-keyword">try</span> {
	PlatformUI.getWorkbench().getActiveWorkbenchWindow().run(<span class="code-keyword">false</span>, <span class="code-keyword">true</span>, <span class="code-keyword">new</span> IRunnableWithProgress(){

	<span class="code-keyword">public</span> void run(IProgressMonitor monitor){
	Envelope bounds = <span class="code-keyword">new</span> Envelope();
	bounds.setToNull();
	Map map=((Layer)selection.getFirstElement()).getContextModel().getMap();
           <span class="code-keyword">for</span>( Iterator iter = (selection).iterator(); iter.hasNext(); ) {
		Layer layer = (Layer) iter.next();
	           <span class="code-keyword">if</span>( layer.getContextModel().getMap()!=map )
		   <span class="code-keyword">return</span>;
	Envelope bbox=<span class="code-keyword">null</span>;
             <span class="code-keyword">try</span> {
                 bbox = layer.getBounds(monitor, map.getViewportModel().getCRS());
                 } <span class="code-keyword">catch</span> (IOException e) {
                 }
      <span class="code-keyword">if</span>( bbox==<span class="code-keyword">null</span>)
               <span class="code-keyword">continue</span>;
      <span class="code-keyword">if</span>( bounds.isNull() )
                bounds.init(bbox);
      <span class="code-keyword">else</span>
         bounds.expandToInclude( bbox );
     <span class="code-keyword">if</span>( !bounds.isNull() ){
         map.sendCommandASync(NavigationCommandFactory.getInstance().createSetViewportBBoxCommand(bounds));
        }
       }
}
});
		} <span class="code-keyword">catch</span> (Exception e) {
			CorePlugin.log(ProjectUIPlugin.getDefault(), e);
		}
    }</pre>
</div></div>

<h3><a name="1Actions-EditorandActions"></a>Editor and Actions</h3>
<p>Uses IEditorActionDelegate ...<br/>
must implement org.eclipse.ui.IEditorActionDelegate interface if contributing to an editor's context menu.<br/>
The interface IEditorActionDelegate allows the action delegate to retarget itself to the active editor.<br/>
The action delegate must implement the method setActiveEditor(IAction action, IEditorPart targetEditor).</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">public</span> class CommitAction <span class="code-keyword">implements</span> IEditorActionDelegate {

    <span class="code-keyword">private</span> MapEditor editor;

    <span class="code-keyword">public</span> void setActiveEditor( IAction action, IEditorPart targetEditor ) {
        editor=(MapEditor) targetEditor;
    }

    <span class="code-keyword">public</span> void run( IAction action ) {
        <span class="code-keyword">try</span> {
            editor.getMap().getEditManagerInternal().commitTransaction();
        } <span class="code-keyword">catch</span> (IOException e) {
            <span class="code-comment">// Shouldn't happen but...
</span>            ProjectUIPlugin.getDefault().getLog().log(<span class="code-keyword">new</span> Status(IStatus.ERROR,
                    <span class="code-quote">"net.refractions.udig.project"</span>,0,<span class="code-quote">"Error commiting transaction"</span>,e)); <span class="code-comment">//$NON-NLS-1$ //$NON-NLS-2$
</span>        }
    }
    <span class="code-keyword">public</span> void selectionChanged( IAction action, ISelection selection ) {
    }
}</pre>
</div></div>
<h3><a name="1Actions-ObjectandActions"></a>Object and Actions</h3>
<p>Uses IObjectActionDelegate ...<br/>
For object contributions, the class attribute of the action element is the name of a Java class that implements the org.eclipse.ui.IObjectActionDelegate interface. The interface IObjectActionDelegate allows the action delegate to retarget itself to the active part.<br/>
The action delegate must implement the method setActivePart(IAction action, IWorkbenchPart targetPart). </p>


<div class="panel" style="border-width: 1px;"><div class="panelHeader" style="border-bottom-width: 1px;"><b>Where are the Actions?</b></div><div class="panelContent">
<p>Proxy Pattern and Actions</p>
<hr />
<p>In the quest for lazy loading of plug-ins the RCP makes use of the proxy pattern to delay the loading of Actions.  For most instances a particular extention point will create a proxy based on configuration information; and it will be this proxy that turns around and creates/calls your class.</p>

<p>This practice explains why we are always implementing IActionDelegate.</p>
</div></div>

<div class="panel" style="border-width: 1px;"><div class="panelHeader" style="border-bottom-width: 1px;"><b>Links</b></div><div class="panelContent">
<ul>
	<li><a href="http://www.eclipse.org/articles/viewArticle/ViewArticle2.html">Creating an Eclipse View</a></li>
	<li><a href="http://www.eclipse.org/articles/Article-action-contribution/Contributing%20Actions%20to%20the%20Eclipse%20Workbench.html">Contributing Actions to the Eclipse workbench</a></li>
</ul>
</div></div>

<small>
  (c) Copyright (c) 2004-2008 Refractions Research Inc. and others.<br>
  <a href="http://udig.refractions.net/confluence/pages/viewpage.action?pageId=8">[wiki]</a>
</small>
    </body>
</html>