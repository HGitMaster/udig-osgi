<html>
    <head>
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="../book.css" type="text/css" />
        <title>UDIG Developer Guide : 5 Tools</title>
    </head>
    <body BGCOLOR="#FFFFFF">
       <!-- UDIG Developer Guide : 5 Tools -->
       <h1>5 Tools</h1>

       <p>Tools must extend the net.refractions.udig.project.ui.tool extension point.  The reference section provides a list of the extension points and technical documentation for the extension points.</p>

<p>All Tools are provided with a ToolContext object by the framework.  The tools can use the context to access the model and to create and send commands which modify the model.  Contexts have a large number of methods to simplify the job of tool authors.  Please let us know of methods that would be useful or should be part of the context objects.</p>

<p><b>IMPORTANT</b>:  It is critical that the tools do not make a new reference to the context object because it is set each time the editor is activated and may change without notification.</p>

<p>There are three classes of tools:</p>
<ol>
	<li><b>Action Tool</b> - A single fire tool that has a run command that is executed when the tool is activated.  An action tool does not change the mouse cursor because it is not modal.  If a tool is needed that fires when clicked within the editor, a modal tool would be a better choice.<br/>
Active Tool Example</li>
	<li><b>Modal Tool</b> - A tool that has on and off modes.  Within UDIG there can only be one active modal tool.  A modal tool does not have a run method, instead is expected to listen for mouse.  The event methods that are currently available are provided in the AbstractTool class with empty implementations.  When active, the cursor defined in extension definition is used as the mouse cursor.<br/>
Modal Tool Example</li>
	<li><b>Background Tool</b> - A tool that is always active in the background.  A typical background tool would be limited to providing user feedback.<br/>
<a href="Background Tool Example.html" title="Background Tool Example">Background Tool Example</a><br/>
Tools are always placed in the Toolbar and in the menu.  The ToolManager is responsible for managing tools.  To add tool buttons to custom views. the ToolManager.createToolAction(ToolID, CategoryID) will create an action that can be added to the view.</li>
</ol>


<p>Examples that are part of uDig:</p>
<ul>
	<li><b>Active Tools</b>
	<ul>
		<li>Zoom to Extent:  A tools that makes the map editor adjust its zoom so that the entire map is framed in the editor.</li>
	</ul>
	</li>
	<li><b>Modal Tools</b>
	<ul>
		<li>Zoom: A tool that allows the zoom towards a location in the map so that the features appear larger.</li>
		<li>Pan:  A tool that allows the user to adjust which part of the map they are viewing; the zoom stays the same.</li>
	</ul>
	</li>
	<li><b>Background Tools</b>
	<ul>
		<li>Cursor position:  Shows the current position of the mouse cursor transformed into world coordinates.</li>
		<li>Quick Zoom (Wheel Zoom): Zooms in and out of the map when the mouse wheel is turned or when</li>
	</ul>
	</li>
</ul>


<p>Tools are grouped in Categories:</p>
<ul>
	<li><b>Category</b> - A collection of tools that are always available but are logically similar and are as a result grouped together.  Each category can have a key assigned to it which has two functions:
	<ul>
		<li>Active the current tool in the category, if not already active.</li>
		<li>If the category is active then the next tool in the category will become active.</li>
	</ul>
	</li>
</ul>


<p>Tool extenders can also register a list of commands with the framework via the extension point definition.  If this is done the Tool extender must also create a IHandler object, which is part of the eclipse command framework.  An instance of the handler will be created for each command and each time a command occurs it will be passed to the handler to be handled.</p>

<h2><a name="5Tools-ToolInterfacesandAbstractClasses"></a>Tool Interfaces and Abstract Classes</h2>
<p><div align="center"><img src="download/attachments/178/Tools.png" border="0"/></div></p>

<h2><a name="5Tools-Toolenablement"></a>Tool enablement</h2>

<p>The <em>Tool</em> interface is extended by several methods:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">Tool.setEnabled(<span class="code-object">Boolean</span>)
Tool.isEnabled()</pre>
</div></div>

<p>This lets to enable/disable toolâs functionality at any time during tool lifecycle. When the tool is disabled, âNOâ cursor is initialized and the functionality is blocked by unregistering mouse listeners.</p>

<p>Only one modal tool can be active. There is no other opportunity to activate another disabled tool through UI contributions. When the tool is disabled, its UI contributions are disabled.</p>

<p>When the active tool is being disabled, its functionality is blocked but the tool is still active. The tool can be enabled by changing of context again. In that case only user manually can switch to any other enabled tool through UI contributions.  </p>

<p>There are several ways to perform tool enablement. First way â&ldquo; the system performs enablement on the base of current context (selecting different layers, etc.). The second way â&ldquo; manually calling <em>Tool.setEnabled(Boolean)</em> from any place of tool implementation to simply block its functionality.</p>

<p>Only currently enabled tool can be activated.</p>

<h2><a name="5Tools-Implementation"></a>Implementation</h2>

<p>Look into <em>AbstractModalTool.setEnabled(Boolean)</em> to get the idea.</p>

<h2><a name="5Tools-Toollifecycle"></a>Tool lifecycle</h2>

<p>I started tool lifecycle listeners: the initial three events are:</p>
<ul>
	<li>tool activation (only one modal item can be active at any time).</li>
	<li>tool enablement (can be performed at any time)</li>
	<li>context changing (during changing of context the tool also can be enabled or disabled automatically)</li>
</ul>


<p>Tool lifecycle listeners are not used anywhere at the current moment, but it would be good to have such functionality to listen tools lifecycle events without overriding of Tool class methods.</p>

<h2><a name="5Tools-Toolcursorsframework"></a>Tool cursors framework</h2>


<h3><a name="5Tools-Extensionpoint"></a>Extension point</h3>

<p>Cursors for tools are cross-cutting concerns and they must be handled independently from  tools with a purpose to be reused.</p>

<p><em>net.refractions.udig.project.ui.tool</em> extension point is revisited with new element toolCursor:</p>

<p><img src="download/attachments/178/extension.png" align="absmiddle" border="0"/></p>

<p>Attributes are:</p>
<ul>
	<li><em>id</em> â&ldquo; is an unique ID of the cursor to be accessed from any place of UDIG platform to get cursor image.</li>
	<li><em>image</em> â&ldquo; path to cursor image inside of plugin</li>
	<li><em>hotspotX, hotspotY</em> â&ldquo; coordinates from top left corner of hot point for the cursor.</li>
</ul>


<p>Once the tool cursor is defined as an extension it is accessible as a default tool cursor by toolCursorId attribute of modalTool element:</p>

<p><img src="download/attachments/178/extensions2.png" align="absmiddle" border="0"/></p>

<p>The cursor ID must be unique. In this case the cursor defined in one plugin can be accessible by the tool from another plugin just by ID.</p>

<h3><a name="5Tools-Implementationdetails"></a>Implementation details</h3>

<p>Cursor is a disposable object and to implement lazy loading the proxy object is used in the same manner as <em>ToolProxy</em> object before:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">net.refractions.udig.project.ui.internal.tool.display.CursorProxy</pre>
</div></div>
<p>ToolManager is responsible to create full list of cursor proxies and cache them by ID from extension point. Whenever the actual <em>org.eclipse.swt.graphics.Cursor</em> object is needed you must call the following method:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">Cursor IToolManager.findToolCursor(<span class="code-object">String</span> cursorID);</pre>
</div></div>
<p>In most cases the developer does not need the org.eclipse.swt.graphics.Cursor object while working with tools implementation. The Tools API is extended by the next methods to manage tool cursors:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">ModalTool.setCursorID(<span class="code-object">String</span> cursorID)
<span class="code-object">String</span> ModalTool.getCursorID()</pre>
</div></div>
<p>These methods are responsible for the cursors management. The set method performs actual updating of mouse cursor image if it is needed.</p>

<h3><a name="5Tools-SWTdefaultsystemcursors"></a>SWT default system cursors</h3>

<p>Systems cursors are listed using constants in SWT class. Constants are integer numbers. While current âTool cursors frameworkâ uses string IDs it is recommended to work with mapped constants from ModalTool interface. These constants are mapped to system cursors. If the system cursor <em>SWT.CURSOR_WAIT</em> is needed then call routine:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">ModalTool.setCursorID(ModalTool.WAIT_CURSOR);</pre>
</div></div>

<p>In this case the framework recognizes that the system cursor is requested and sets it for the tool. You can combine as custom cursors as system using the underlying mechanism transparently.</p>


<h3><a name="5Tools-Advantages"></a>Advantages</h3>

<p>The developer can declaratively add cursor images through extension mechanism and use them by ID from any place in source code. If the SWT object is needed call</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">IToolManager.findToolCursor(<span class="code-object">String</span> cursorID).</pre>
</div></div>

<p>If you just want to set cursor for the tool just call</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">ModalTool.setCursorID(<span class="code-object">String</span> cursorID).</pre>
</div></div>


<p>Updating of mouse cursor image is performed automatically  by the framework depending on the current context, active tool, etc.</p>

<h3><a name="5Tools-Compatibility"></a>Compatibility</h3>

<p>It is possible to support compatibility with cursor extension point under tool extension point as a default cursor for the tool.</p>

<h2><a name="5Tools-FutureAPIConsiderations"></a>Future API Considerations</h2>
<p>Currently all tools are active but in the future would be desirable to have a tool configuration extension point where udig extenders can define which tools are activated for their application.  A system like the eclipse command framework for Eclipse 3.1 is likely.</p>

<small>
  (c) Copyright (c) 2004-2008 Refractions Research Inc. and others.<br>
  <a href="http://udig.refractions.net/confluence/pages/viewpage.action?pageId=178">[wiki]</a>
</small>
    </body>
</html>