<html>
    <head>
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="../book.css" type="text/css" />
        <title>UDIG Developer Guide : 07 New Menus based on Commands, Handlers and Key Bindings</title>
    </head>
    <body BGCOLOR="#FFFFFF">
       <!-- UDIG Developer Guide : 07 New Menus based on Commands, Handlers and Key Bindings -->
       <h1>07 New Menus based on Commands, Handlers and Key Bindings</h1>

       <p>The menu systems has been over hauled for Eclipse 3.3; so best practise has changed a bit for uDig 1.1.</p>

<ul>
	<li><a href="#07NewMenusbasedonCommands%2CHandlersandKeyBindings-Commands">Commands</a> Declare functionality</li>
	<li><a href="#07NewMenusbasedonCommands%2CHandlersandKeyBindings-Handlers">Handlers</a> Implement functionality for specific commands</li>
	<li><a href="#07NewMenusbasedonCommands%2CHandlersandKeyBindings-KeyBindings">Key Bindings</a></li>
	<li><a href="#07NewMenusbasedonCommands%2CHandlersandKeyBindings-Context">Context</a> Make available commands context sensitive</li>
	<li><a href="#07NewMenusbasedonCommands%2CHandlersandKeyBindings-Menus">Menus</a> position commands in the user interface (everything from the menu bar to context menus)</li>
</ul>


<p>Related Information:</p>
<ul class="alternate" type="square">
	<li><a href="http://richclientplatform.blogspot.com/2007/07/new-menu-contribution-extension.html">New menu contribution extention</a></li>
</ul>




<h1><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-Commands"></a>Commands</h1>

<p>Commands are used to declare desired behaviour (ie <b>Show</b> would be a command). They can be organized into categories (like Navigation).</p>

<p>Implementations for your commands are called handlers, the handler used may be context sensitive:</p>
<ul class="alternate" type="square">
	<li>Show command on the Map Editor may zoom out to show all the layers</li>
	<li>Show command on the Layer View may zoom out to show the selected layer</li>
	<li>Show command on the Table View may zoom out to show the current selection</li>
</ul>


<p>Commands can get a bit more fancy:</p>
<ul class="alternate" type="square">
	<li>You can use categories to organize your commands</li>
	<li>You can use parameters (this is how the "Show View" command is implemented once and configured to show multiple views.</li>
</ul>


<h4><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-RelatedInformation"></a>Related Information</h4>
<ul>
	<li><a href="http://help.eclipse.org/help33/index.jsp?topic=/org.eclipse.platform.doc.isv/reference/extension-points/org_eclipse_ui_commands.html">org.eclipse.ui.commands</a> extension point</li>
	<li><a href="http://wiki.eclipse.org/Platform_Command_Framework#Commands">platform command framework</a> in the eclipse wiki</li>
	<li><a href="http://help.eclipse.org/help33/topic/org.eclipse.platform.doc.isv/guide/workbench_cmd_commands.htm">Basic workbench extension points using commands</a> in the PDE programmers guide.</li>
</ul>


<h2><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-CreatinganewCommandusingtheExtensionPoint"></a>Creating a new Command using the Extension Point</h2>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-xml">&lt;extension
      point=<span class="code-quote">"org.eclipse.ui.commands"</span>&gt;
   &lt;category
         description=<span class="code-quote">"Actions that change what is shown"</span>
         id=<span class="code-quote">"net.refractions.udig.navigation"</span>
         name=<span class="code-quote">"Navigation"</span>&gt;
   <span class="code-tag">&lt;/category&gt;</span>
   &lt;command
         categoryId=<span class="code-quote">"net.refractions.udig.navigation"</span>
         description=<span class="code-quote">"Show all content"</span>
         id=<span class="code-quote">"net.refractions.udig.show"</span>
         name=<span class="code-quote">"Show All"</span>&gt;
   <span class="code-tag">&lt;/command&gt;</span>
<span class="code-tag">&lt;/extension&gt;</span></pre>
</div></div>

<h2><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-CreatinganewCommandusingJava"></a>Creating a new Command using Java</h2>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">ICommandService cmdService =
  (ICommandService) getSite().getService(ICommandService.class);

Category navigation =
  cmdService.getCategory(<span class="code-quote">"net.refractions.udig.navigation"</span>);

<span class="code-keyword">if</span> (!navigation.isDefined()) {
  navigation.define(<span class="code-quote">"Navigation"</span>, <span class="code-quote">"Actions that change what is shown"</span>);
}

Command show =
  cmdService.getCommand(<span class="code-quote">"net.refractions.udig.show"</span>);

<span class="code-keyword">if</span> (!show.isDefined()) {
  show.define(<span class="code-quote">"Show"</span>, <span class="code-quote">"Show content on screen"</span>, navigation);
}</pre>
</div></div>

<p>To get the workbench ICommandService:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">public</span> class StartupOperations <span class="code-keyword">implements</span> IStartup {
    <span class="code-keyword">public</span> void earlyStartup(){
       IWorkbench workbench = PlatformUI.getWorkbench();
       ICommandService cmdService = (ICommandService) workbench.getService( ICommandService.class );
       ...
    }
}</pre>
</div></div>

<h1><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-Handlers"></a>Handlers</h1>

<p>Handlers are an implementation of a command. Several handlers may be defined for a given command - choosing which one is active is the fun part.</p>

<h3><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-FiguringouttheActiveHandler"></a>Figuring out the Active Handler</h3>

<p>You can define an <b>activeWhen</b> expressions in order to make your handler context sensitive.</p>

<p>A handler is chosen based on several bits of magic:</p>
<ul>
	<li>Variables used in activeWhen expressions are compared; the handler with the most specific variables is chosen</li>
	<li>Default Handler (ie one with no conditions) is used as the last resort.</li>
</ul>


<h3><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-FiguringoutiftheHandlerisEnabled"></a>Figuring out if the Handler is Enabled</h3>

<p>You can also define an expression to enabled or disable the handler.</p>

<h3><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-AvailableExpressionVariable"></a>Available Expression Variable</h3>

<p>The variables used in the activeWhen and enabledWhen expressions come from <b>org.eclipse.ui.ISources</b>; and we will probably have to contribute some uDig specific ones. For now we are sticking with the normal RCP stuff:</p>
<ul>
	<li>Selection</li>
	<li>activeContexts - used to make uDig nice and modal</li>
	<li>etc...</li>
</ul>


<h2><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-CreatingaHandlerusingtheExtentionPoint"></a>Creating a Handler using the Extention Point</h2>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-xml">&lt;extension
      point=<span class="code-quote">"org.eclipse.ui.handlers"</span>&gt;
   &lt;handler
         class=<span class="code-quote">"net.refractions.udig.handlers.showMap"</span>
         commandId=<span class="code-quote">"net.refractions.udig.show"</span>&gt;
      <span class="code-tag">&lt;activeWhen&gt;</span>
         <span class="code-tag">&lt;with variable=<span class="code-quote">"activeContexts"</span>&gt;</span>
            <span class="code-tag">&lt;iterate operator=<span class="code-quote">"or"</span>&gt;</span>
               <span class="code-tag">&lt;equals value=<span class="code-quote">"net.refractions.udig.contexts.map"</span>/&gt;</span>
            <span class="code-tag">&lt;/iterate&gt;</span>
         <span class="code-tag">&lt;/with&gt;</span>
      <span class="code-tag">&lt;/activeWhen&gt;</span>
   <span class="code-tag">&lt;/handler&gt;</span>
   &lt;handler
         class=<span class="code-quote">"net.refractions.udig.handlers.showFeature"</span>
         commandId=<span class="code-quote">"net.refractions.udig.show"</span>&gt;
      <span class="code-tag">&lt;activeWhen&gt;</span>
         <span class="code-tag">&lt;with variable=<span class="code-quote">"activeContexts"</span>&gt;</span>
            <span class="code-tag">&lt;iterate operator=<span class="code-quote">"or"</span>&gt;</span>
               <span class="code-tag">&lt;equals value=<span class="code-quote">"net.refractions.udig.contexts.feature"</span>/&gt;</span>
            <span class="code-tag">&lt;/iterate&gt;</span>
         <span class="code-tag">&lt;/with&gt;</span>
      <span class="code-tag">&lt;/activeWhen&gt;</span>
   <span class="code-tag">&lt;/handler&gt;</span>
   &lt;handler
         class=<span class="code-quote">"net.refractions.udig.handlers.showSelection"</span>
         commandId=<span class="code-quote">"net.refractions.udig.show"</span>&gt;
      <span class="code-tag">&lt;activeWhen&gt;</span>
         <span class="code-tag">&lt;with variable=<span class="code-quote">"activeContexts"</span>&gt;</span>
            <span class="code-tag">&lt;iterate operator=<span class="code-quote">"or"</span>&gt;</span>
               <span class="code-tag">&lt;equals value=<span class="code-quote">"net.refractions.udig.contexts.selection"</span>/&gt;</span>
            <span class="code-tag">&lt;/iterate&gt;</span>
         <span class="code-tag">&lt;/with&gt;</span>
      <span class="code-tag">&lt;/activeWhen&gt;</span>
   <span class="code-tag">&lt;/handler&gt;</span>
<span class="code-tag">&lt;/extension&gt;</span></pre>
</div></div>

<h2><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-CreatingaHandlerusingJava"></a>Creating a Handler using Java</h2>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">// pending</span></pre>
</div></div>

<h1><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-KeyBindings"></a>Key Bindings</h1>

<p>Key bindings are one of the things that cannot be updated Programatically; however they will only be active when the context is active.</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-xml">&lt;extension
      point=<span class="code-quote">"org.eclipse.ui.bindings"</span>&gt;
   &lt;key
         commandId=<span class="code-quote">"net.refractions.show"</span>
         contextId=<span class="code-quote">"net.refractions.udig.contexts.feature"</span>
         schemeId=<span class="code-quote">"org.eclipse.ui.defaultAcceleratorConfiguration"</span>
         sequence=<span class="code-quote">"HOME"</span>&gt;
   <span class="code-tag">&lt;/key&gt;</span>
   &lt;key
         commandId=<span class="code-quote">"net.refractions.show"</span>
         contextId=<span class="code-quote">"net.refractions.udig.contexts.map"</span>
         schemeId=<span class="code-quote">"org.eclipse.ui.defaultAcceleratorConfiguration"</span>
         sequence=<span class="code-quote">"HOME"</span>&gt;
   <span class="code-tag">&lt;/key&gt;</span>
   &lt;key
         commandId=<span class="code-quote">"net.refractions.show"</span>
         contextId=<span class="code-quote">"net.refractions.udig.contexts.selection"</span>
         schemeId=<span class="code-quote">"org.eclipse.ui.defaultAcceleratorConfiguration"</span>
         sequence=<span class="code-quote">"HOME"</span>&gt;
   <span class="code-tag">&lt;/key&gt;</span>
<span class="code-tag">&lt;/extension&gt;</span></pre>
</div></div>

<h1><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-Context"></a>Context</h1>

<p>Contexts are used to make the application respond to what is going on (in a context sensitive manner). For uDig this means that the application menu and tool bars will respond based on what kind of content the current View or Map Editor is working with.</p>

<p>To make your view context sensitive add the following to createPartControl(..):</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">public</span> void createPartControl(Composite parent) {
  ...
  IContextService contextService =
     (IContextService) getSite().getService(IContextService.class);

  IContextActivation contextActivation =
     contextService.activateContext(<span class="code-quote">"net.refractions.udig.contexts.selection"</span>);
}</pre>
</div></div>

<h4><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-RelatedInformation"></a>Related Information</h4>

<ul>
	<li><a href="http://help.eclipse.org/help33/topic/org.eclipse.platform.doc.isv/guide/workbench_advext_contexts.htm">Contexts</a> in the PDE programmers guide.</li>
</ul>


<h2><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-CreatingaContextusingtheExtensionPoint"></a>Creating a Context using the Extension Point</h2>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-xml">&lt;extension
      point=<span class="code-quote">"org.eclipse.ui.contexts"</span>&gt;
   &lt;context
         description=<span class="code-quote">"To allow interaction with layer selection"</span>
         id=<span class="code-quote">"net.refractions.udig.contexts.selection"</span>
         name=<span class="code-quote">"Layer Selection"</span>
         parentId=<span class="code-quote">"org.eclipse.ui.contexts.window"</span>&gt;
   <span class="code-tag">&lt;/context&gt;</span>
<span class="code-tag">&lt;/extension&gt;</span></pre>
</div></div>

<h2><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-CreatingaContextusingJava"></a>Creating a Context using Java</h2>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">Context layerSelection = contextService
    .getContext(<span class="code-quote">"net.refractions.udig.contexts.selection"</span>);
<span class="code-keyword">if</span> (!layerSelection .isDefined()) {
  tacos.define(<span class="code-quote">"Layer Selection"</span>, <span class="code-quote">"To allow interaction with layer selection"</span>,
      <span class="code-quote">"org.eclipse.ui.contexts.window"</span>);
}</pre>
</div></div>

<h1><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-Menus"></a>Menus</h1>

<p>Menus are where the rubber meets the road; commands and controls can be dropped into the correct part of the application using a range of targets.</p>

<h2><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-Location"></a>Location</h2>

<p>These targets are similar to the old menus path stuff - but are far more capable:</p>

<ul>
	<li>menu:org.eclipse.ui.main.menu?after=additions <br clear="all" /> Drop a menu into the usual spot on the main menubar</li>
	<li>toolbar:net.refractions.udig.views.catalog?after=additions <br clear="all" /> Add actions to the catalog toolbar</li>
	<li>etc...</li>
</ul>


<h2><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-Visibility"></a>Visibility</h2>

<p>You can do the same trick with expressions (ie using <b>visibleWhen</b>) to make your application change based on what is going on.</p>

<p>To reproduce the usual visibility based on ActionSet story; your visibileWhen expression will need to check the global action sets list. As action sets are enabled/disabled during Perspective changes your menus will follow suite.</p>

<h2><a name="07NewMenusbasedonCommands%2CHandlersandKeyBindings-MenuUsingExtensionPoint"></a>Menu Using Extension Point</h2>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-xml">&lt;extension
         point=<span class="code-quote">"org.eclipse.ui.menus"</span>&gt;
      &lt;menuContribution
            locationURI=<span class="code-quote">"menu:org.eclipse.ui.main.menu?after=additions"</span>&gt;
         &lt;menu
               id=<span class="code-quote">"net.refractions.udig.menu.navigate"</span>
               label=<span class="code-quote">"Navigate"</span>
               mnemonic=<span class="code-quote">"N"</span>
               tooltip=<span class="code-quote">"Navigation Commands"</span>&gt;
            &lt;command
                  commandId=<span class="code-quote">"net.refractions.udig.show"</span>&gt;            
            <span class="code-tag">&lt;visibleWhen&gt;</span>
               &lt;with
                     variable=<span class="code-quote">"activeContexts"</span>&gt;
                  &lt;iterate
                        operator=<span class="code-quote">"or"</span>&gt;
                     &lt;equals
                           value=<span class="code-quote">"net.refractions.udig.contexts.selection"</span>&gt;
                     <span class="code-tag">&lt;/equals&gt;</span>
                  <span class="code-tag">&lt;/iterate&gt;</span>
               <span class="code-tag">&lt;/with&gt;</span>
            <span class="code-tag">&lt;/visibleWhen&gt;</span>
            <span class="code-tag">&lt;/command&gt;</span>
         <span class="code-tag">&lt;/menu&gt;</span>
      <span class="code-tag">&lt;/menuContribution&gt;</span></pre>
</div></div>

<small>
  (c) Copyright (c) 2004-2008 Refractions Research Inc. and others.<br>
  <a href="http://udig.refractions.net/confluence/pages/viewpage.action?pageId=11123">[wiki]</a>
</small>
    </body>
</html>