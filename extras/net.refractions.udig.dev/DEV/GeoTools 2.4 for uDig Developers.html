<html>
    <head>
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="../book.css" type="text/css" />
        <title>UDIG Developer Guide : GeoTools 2.4 for uDig Developers</title>
    </head>
    <body BGCOLOR="#FFFFFF">
       <!-- UDIG Developer Guide : GeoTools 2.4 for uDig Developers -->
       <h1>GeoTools 2.4 for uDig Developers</h1>

       <p>The formal API changes are documented on the GeoTools website:</p>
<ul class="alternate" type="square">
	<li><a href="http://docs.codehaus.org/display/GEOTOOLS/Upgrade+to+2.4">Upgrade to GeoTools 2.4</a></li>
	<li><a href="http://docs.codehaus.org/display/GEOTOOLS/Upgrade+to+2.3">Upgrade to GeoTools 2.3</a></li>
</ul>


<p>This page contains a list of the modifications required to the uDig codebase when transitioning from GeoTools 2.2 to GeoTools 2.4.</p>

<h2><a name="GeoTools2.4foruDigDevelopers-UseofAttributeType.getRestriction%28%29"></a>Use of AttributeType.getRestriction()</h2>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">//<span class="code-keyword">return</span> attributeType.getRestriction().accepts(feature);
</span><span class="code-keyword">return</span> attributeType.getRestriction().evaluate(feature);</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-Useoforg.geotools.referencing.CRS"></a>Use of org.geotools.referencing.CRS</h2>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">//MathTransform mt = CRS.transform(coordCRS, destinationCRS, <span class="code-keyword">true</span>);
</span>MathTransform mt = CRS.findMathTransform(coordCRS, destinationCRS, <span class="code-keyword">true</span>);</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-Extensionoforg.geotools.util.ProgressListener"></a>Extension of org.geotools.util.ProgressListener</h2>

<p>Implementations will need to add the following method:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">return</span> <span class="code-keyword">new</span> ProgressListener(){
   ...
   <span class="code-keyword">public</span> void setTask( InternationalString task ) {
       setDescription( task.toString() );
   }
}</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-Anycustomextensionsoforg.geotools.filter.AbstractFilter"></a>Any custom extensions of org.geotools.filter.AbstractFilter</h2>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">class SelectionFilteretends AbstractFilter <span class="code-keyword">implements</span> FidFilter {   
    <span class="code-comment">// #1 constructor needs filter factory
</span>    SelectionFilter(Collection&lt;<span class="code-object">String</span>&gt; fids){    
       <span class="code-keyword">super</span>( (FilterFactory) CommonFactoryFinder.getFilterFactory(<span class="code-keyword">null</span>));
       ....
    }
    <span class="code-comment">// #2 contains is now <span class="code-keyword">final</span>, and a calls evaulate    
</span>    <span class="code-comment">//
</span>    <span class="code-comment">// <span class="code-keyword">public</span> <span class="code-object">boolean</span> contains( Feature feature ) {
</span>    <span class="code-keyword">public</span> <span class="code-object">boolean</span> evaulate( Feature feature ) {
        <span class="code-keyword">return</span> selectionFids.contains(feature.getID());
    }

    <span class="code-comment">// #3 remove boilerplate visitor code
</span>    <span class="code-comment">//
</span>    <span class="code-comment">//<span class="code-keyword">public</span> void accept( FilterVisitor arg0 ) {
</span>    <span class="code-comment">//   arg0.visit(<span class="code-keyword">this</span>);
</span>    <span class="code-comment">//}
</span>
   <span class="code-comment">// #4 implement the helper methods using provided factory
</span>   <span class="code-keyword">public</span> Filter and( org.opengis.filter.Filter filter ) {
       <span class="code-keyword">return</span> factory.and( <span class="code-keyword">this</span>, filter );
   }
   <span class="code-keyword">public</span> Filter or( org.opengis.filter.Filter filter ) {
       <span class="code-keyword">return</span> (Filter) factory.or( <span class="code-keyword">this</span>, filter );
   }
   <span class="code-comment">// #5 meet any <span class="code-keyword">new</span> GeoAPI contracts
</span>   <span class="code-keyword">public</span> Set&lt;Identifier&gt; getIdentifiers() {
       Set&lt;Identifier&gt; ids = <span class="code-keyword">new</span> HashSet&lt;Identifier&gt;();
       <span class="code-keyword">for</span>( <span class="code-object">String</span> fid : selectionFids ){
          ids.add( <span class="code-keyword">new</span> FeatureIdImpl( fid ));
       }
       <span class="code-keyword">return</span> ids;
   }
}</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-Anyuseoforg.geotools.referencingFactoryFinder"></a>Any use of org.geotools.referencing FactoryFinder</h2>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">// load(FactoryFinder.getCoordinateOperationAuthorityFactories());
</span>load(FactoryFinder.getCoordinateOperationAuthorityFactories( <span class="code-keyword">null</span> ));

<span class="code-comment">// load(FactoryFinder.getCoordinateOperationAuthorityFactories());
</span>load(FactoryFinder.getCoordinateOperationAuthorityFactories( <span class="code-keyword">null</span> ));

<span class="code-comment">// load(FactoryFinder.getCRSFactories());
</span>load(FactoryFinder.getCRSFactories(<span class="code-keyword">null</span>));

<span class="code-comment">// load(FactoryFinder.getCSFactories());
</span>load(FactoryFinder.getCSFactories(<span class="code-keyword">null</span>));

<span class="code-comment">// load(FactoryFinder.getDatumAuthorityFactories());
</span>load(FactoryFinder.getDatumAuthorityFactories(<span class="code-keyword">null</span>));

<span class="code-comment">// load(FactoryFinder.getDatumFactories());
</span>load(FactoryFinder.getDatumFactories(<span class="code-keyword">null</span>));

<span class="code-comment">// load(FactoryFinder.getMathTransformFactories());
</span>load(FactoryFinder.getMathTransformFactories(<span class="code-keyword">null</span>));</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-FilterHandler"></a>FilterHandler</h2>

<p>Change to org.opengis.filter.Filter</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">public</span> <span class="code-keyword">static</span> class SimpleFilterHandler <span class="code-keyword">extends</span> DefaultHandler <span class="code-keyword">implements</span> FilterHandler {
    <span class="code-keyword">private</span> org.opengis.filter.Filter filter;
    <span class="code-keyword">public</span> void filter( org.opengis.filter.Filter filter ) {
        <span class="code-keyword">this</span>.filter = filter;
    }
    <span class="code-keyword">public</span> org.opengis.filter.Filter getFilter() {
        <span class="code-keyword">return</span> filter;
    }
}</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-CustomClassifierFunctionmissing"></a>CustomClassifierFunction missing</h2>

<p>No replacement available? Apparently this was a bad idea:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">\\customBreak = <span class="code-keyword">new</span> CustomClassifierFunction();</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-StreamingRenderer.DEFAULTLISTENER"></a>StreamingRenderer.DEFAULT_LISTENER</h2>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">//renderer.removeRenderListener(StreamingRenderer.DEFAULT_LISTENER);</span></pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-GeodeticCalculator"></a>GeodeticCalculator</h2>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">//calc.setAnchorPosition(<span class="code-keyword">new</span> DirectPosition2D(min.x, min.y));
</span>calc.setStartingGeographicPoint(<span class="code-keyword">new</span> DirectPosition2D(min.x, min.y));</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-GridCoverageExchange"></a>GridCoverageExchange</h2>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">//<span class="code-keyword">import</span> org.geotools.coverage.grid.GridCoverageExchange;
</span><span class="code-keyword">import</span> org.opengis.coverage.grid.GridCoverageExchange;</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-JTS%28%26JTS.ReferenceEnvelope%29"></a>JTS (&amp;JTS.ReferenceEnvelope)</h2>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">//<span class="code-keyword">import</span> org.geotools.geometry.JTS;
</span><span class="code-keyword">import</span> org.geotools.geometry.jts.JTS;
<span class="code-keyword">import</span> org.geotools.geometry.jts.ReferencedEnvelope;

...

<span class="code-comment">//Envelope envelope = JTS.empty();
</span>Envelope envelope = <span class="code-keyword">new</span> Envelope();

<span class="code-keyword">return</span> <span class="code-keyword">new</span> ReferencedEnvelope( envelope, crs );</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-CRSUtilities.getEnvelopemovedtoCRS.getEnvelope"></a>CRSUtilities.getEnvelope moved to CRS.getEnvelope</h2>

<p>No idea what to replace this with!</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">//envelope = CRSUtilities.getEnvelope(crs);
</span>envelope = CRS.getEnvelope(crs);</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-FeatureCollection.reader%28%29"></a>FeatureCollection.reader()</h2>

<p>BEFORE</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">for</span>( FeatureReader iter = source.getFeatures().reader(); iter.hasNext();){
   Feature element = iter.next();
   ...
}</pre>
</div></div>
<p>AFTER</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">FeatureIterator iter = source.getFeatures().features();
<span class="code-keyword">try</span> {
    <span class="code-keyword">while</span>( iter.hasNext() ){
        Feature element = iter.next();
        ...
    }
}<span class="code-keyword">finally</span> {
    iter.close();
}</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-CRS.decodenowthrowsFactoryException%21"></a>CRS.decode now throws FactoryException!</h2>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">try</span> {
    crs = CRS.decode(<span class="code-quote">"EPSG:4326"</span>); <span class="code-comment">//$NON-NLS-1$
</span>} <span class="code-keyword">catch</span> (NoSuchAuthorityCodeException e) {
    <span class="code-keyword">throw</span> (IOException) <span class="code-keyword">new</span> IOException(
        Messages.WMSGeoResourceImpl_bounds_unavailable
    ).initCause( e ); 
} <span class="code-keyword">catch</span> (FactoryException e) { <span class="code-comment">// required <span class="code-keyword">for</span> geotools 2.4
</span>                <span class="code-keyword">throw</span> (RuntimeException) <span class="code-keyword">new</span> RuntimeException(
                        Messages.WMSGeoResourceImpl_bounds_unavailable
                ).initCause( e );
            }</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-WorldImageFormat.ENVELOPE"></a>WorldImageFormat.ENVELOPE</h2>

<p>This parameter no longer appears to be supported?</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">ParameterDescriptor env = WorldImageFormat.ENVELOPE;</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-ValidationProcess.runFeatureTests"></a>ValidationProcess.runFeatureTests</h2>

<p>Simplified to work with FeatureCollection directly:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">//runFeatureTests( dataStoreID, type, collection.reader(), results );
</span>runFeatureTests( dataStoreID, collection, results );</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-GridCoverageRendererMoved"></a>GridCoverageRenderer Moved</h2>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">//<span class="code-keyword">import</span> org.geotools.renderer.lite.GridCoverageRenderer;
</span><span class="code-keyword">import</span> org.geotools.renderer.lite.gridcoverage2d.GridCoverageRenderer;</pre>
</div></div>

<h2><a name="GeoTools2.4foruDigDevelopers-GridCoverageRendererhasDifferentAPI"></a>GridCoverageRenderer has Different API</h2>

<p>AFTER:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">CoordinateReferenceSystem destinationCRS = getContext().getCRS();
                              
Envelope envelope = getRenderBounds();
<span class="code-keyword">if</span>( envelope == <span class="code-keyword">null</span> || envelope.isNull()){
    envelope = getContext().getViewportModel().getBounds();
}
Point upperLeft = getContext().worldToPixel( <span class="code-keyword">new</span> Coordinate( envelope.getMinX(), envelope.getMinY()) );
Point bottomRight = getContext().worldToPixel( <span class="code-keyword">new</span> Coordinate( envelope.getMaxX(), envelope.getMaxY()) );
Rectangle screenSize = <span class="code-keyword">new</span> Rectangle( upperLeft );
screenSize.add( bottomRight );
                
GridCoverageRenderer paint = <span class="code-keyword">new</span> GridCoverageRenderer( destinationCRS, envelope, screenSize );
             
RasterSymbolizer symbolizer = CommonFactoryFinder.getStyleFactory(<span class="code-keyword">null</span>).createRasterSymbolizer();
                
paint.paint( graphics, coverage, symbolizer );</pre>
</div></div>

<h4><a name="GeoTools2.4foruDigDevelopers-FeatureCollection.collection%28%29removed"></a>FeatureCollection.collection() removed</h4>

<p>To quickly preserver old functionality make a copy:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">// <span class="code-keyword">return</span> features.collection();
</span><span class="code-keyword">return</span> DataUtilities.collection( features );</pre>
</div></div>

<h4><a name="GeoTools2.4foruDigDevelopers-UpdateFactoryFinder"></a>Update FactoryFinder</h4>

<p>Although covered by the geotools page it happens often enough that this example is useful:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">//LogicFilter logicFilter;
</span>Filter logicFilter;

<span class="code-comment">//logicFilter = createFilterFactory.createLogicFilter(oldFilter, filter, FilterType.LOGIC_OR);
</span>logicFilter = createFilterFactory.and(oldFilter, filter);</pre>
</div></div>

<small>
  (c) Copyright (c) 2004-2008 Refractions Research Inc. and others.<br>
  <a href="http://udig.refractions.net/confluence/pages/viewpage.action?pageId=9455">[wiki]</a>
</small>
    </body>
</html>