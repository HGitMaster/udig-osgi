<html>
    <head>
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="../book.css" type="text/css" />
        <title>UDIG Developer Guide : 06 Tools</title>
    </head>
    <body BGCOLOR="#FFFFFF">
       <!-- UDIG Developer Guide : 06 Tools -->
       <h1>06 Tools</h1>

       <p>Tools must extend the <b>net.refractions.udig.project.ui.tool</b> extension point. The reference section provides a list of the extension points and technical documentation for the extension points.</p>

<div>
<ul>
    <li><a href='#06Tools-ToolExtensionPointandAPI'>Tool Extension Point and API</a></li>
<ul>
    <li><a href='#06Tools-BackgroundToolExtension'>Background Tool Extension</a></li>
<ul>
    <li><a href='#06Tools-ActionToolExtension'>Action Tool Extension</a></li>
    <li><a href='#06Tools-ModalToolExtension'>Modal Tool Extension</a></li>
</ul>
    <li><a href='#06Tools-ToolCategoriesExtension'>Tool Categories Extension</a></li>
<ul>
    <li><a href='#06Tools-ActionSetconventionforToolCategory'>ActionSet convention for Tool Category</a></li>
</ul>
    <li><a href='#06Tools-ToolCursorExtension'>Tool Cursor Extension</a></li>
</ul>
    <li><a href='#06Tools-ToolImplementationandFramework'>Tool Implementation and Framework</a></li>
<ul>
    <li><a href='#06Tools-ToolManager'>ToolManager</a></li>
    <li><a href='#06Tools-ToolContext'>ToolContext</a></li>
    <li><a href='#06Tools-ToolImplementation'>Tool Implementation</a></li>
<ul>
    <li><a href='#06Tools-ToolLifecycle'>Tool Lifecycle</a></li>
    <li><a href='#06Tools-ToolActivation'>Tool Activation</a></li>
    <li><a href='#06Tools-ToolEnablement'>Tool Enablement</a></li>
    <li><a href='#06Tools-ToolLifecycleListeners'>Tool Lifecycle Listeners</a></li>
</ul>
    <li><a href='#06Tools-ToolCursorImplementation'>Tool Cursor Implementation</a></li>
<ul>
    <li><a href='#06Tools-UsingDefaultSystemCursors'>Using Default System Cursors</a></li>
    <li><a href='#06Tools-FindingaCursoratRuntime'>Finding a Cursor at Runtime</a></li>
    <li><a href='#06Tools-Compatibility'>Compatibility</a></li>
</ul>
</ul>
    <li><a href='#06Tools-FutureDirection'>Future Direction</a></li>
</ul></div>

<h1><a name="06Tools-ToolExtensionPointandAPI"></a>Tool Extension Point and API</h1>

<p>Tools are used to capture user interaction with the Map Editor. Tools have access to a range of information (via a ToolContext) and can issue commands to update the editor.</p>

<p><img src="download/attachments/178/tool.GIF" align="absmiddle" border="0"/></p>

<h2><a name="06Tools-BackgroundToolExtension"></a>Background Tool Extension</h2>

<p>A background tool is always active in the background watching what the user is doing. When used in this fashion a tool would be limited to providing user feedback.</p>

<p>Example:</p>
<ul>
	<li>Cursor position:  Shows the current position of the mouse cursor transformed into world coordinates.</li>
	<li>Quick Zoom (Wheel Zoom): Zooms in and out of the map when the mouse wheel is turned or when</li>
</ul>


<p>Extension Point Example:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-xml"><span class="code-tag">&lt;extension point=<span class="code-quote">"net.refractions.udig.project.ui.tool"</span>&gt;</span>
    &lt;backgroundTool
        name=<span class="code-quote">"%cursorPosition.name"</span>
        class=<span class="code-quote">"net.refractions.udig.tools.internal.CursorPosition"</span>
        id=<span class="code-quote">"net.refractions.udig.tools.backgroundTool1"</span>&gt;
    <span class="code-tag">&lt;/backgroundTool&gt;</span>
    ...
<span class="code-tag">&lt;/extension&gt;</span></pre>
</div></div>

<h3><a name="06Tools-ActionToolExtension"></a>Action Tool Extension</h3>

<p>A single fire tool that has a run command that is executed when the tool is activated.  An action tool does not change the mouse cursor because it is not modal.  If a tool is needed that fires when clicked within the editor, a modal tool would be a better choice.</p>

<p>Example:</p>
<ul>
	<li>Zoom to Extent:  A tools that makes the map editor adjust its zoom so that the entire map is framed in the editor.</li>
</ul>


<p>Extension Point example:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-xml"><span class="code-tag">&lt;extension point=<span class="code-quote">"net.refractions.udig.project.ui.tool"</span>&gt;</span>
     &lt;extension
         point=<span class="code-quote">"net.refractions.udig.project.ui.tool"</span>&gt;
         &lt;actionTool
               categoryId=<span class="code-quote">"net.refractions.udig.tool.category.render"</span>
               class=<span class="code-quote">"net.refractions.udig.tools.internal.RefreshTool"</span>
               commandIds=<span class="code-quote">"net.refractions.udig.tools.refreshCommand"</span>
               icon=<span class="code-quote">"icons/etool16/refresh_co.gif"</span>
               id=<span class="code-quote">"net.refractions.udig.tools.refresh"</span>
               menuPath=<span class="code-quote">"file/refresh"</span>
               name=<span class="code-quote">"%refresh.name"</span>
               onToolbar=<span class="code-quote">"true"</span>
               tooltip=<span class="code-quote">"%refresh.tooltip"</span>&gt;
         <span class="code-tag">&lt;/actionTool&gt;</span> 
    ...
<span class="code-tag">&lt;/extension&gt;</span></pre>
</div></div>

<h3><a name="06Tools-ModalToolExtension"></a>Modal Tool Extension</h3>

<p>A tool that has both <b>on</b> and <b>off</b> mode.  Within UDIG there can only be one active modal tool.  A modal tool does not have a run method, instead is expected to listen to mouse events.  The event methods that are currently available are provided in the <b>AbstractTool</b> class with empty implementations.  When active, the cursor defined in extension definition is used as the mouse cursor.</p>

<p>Example:</p>
<ul>
	<li>Zoom: A tool that allows the zoom towards a location in the map so that the features appear larger.</li>
	<li>Pan:  A tool that allows the user to adjust which part of the map they are viewing; the zoom stays the same.</li>
</ul>


<p>Extension point example:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-xml"><span class="code-tag">&lt;extension point=<span class="code-quote">"net.refractions.udig.project.ui.tool"</span>&gt;</span>
         &lt;modalTool
               categoryId=<span class="code-quote">"net.refractions.udig.tool.category.zoom"</span>
               class=<span class="code-quote">"net.refractions.udig.tools.internal.Zoom"</span>
               cursor=<span class="code-quote">"crosshair"</span>
               icon=<span class="code-quote">"icons/etool16/zoom_mode.gif"</span>
               id=<span class="code-quote">"net.refractions.udig.tools.Zoom"</span>
               name=<span class="code-quote">"%zoom.tool.name"</span>
               onToolbar=<span class="code-quote">"true"</span>
               toolCursorId=<span class="code-quote">"zoomCursor"</span>
               tooltip=<span class="code-quote">"%zoom.tool.tooltip"</span>&gt;
         <span class="code-tag">&lt;/modalTool&gt;</span>
    ...
<span class="code-tag">&lt;/extension&gt;</span></pre>
</div></div>

<h2><a name="06Tools-ToolCategoriesExtension"></a>Tool Categories Extension</h2>

<p>A <b>Category</b> represents a collection of tools that are always available but are logically similar and are as a result grouped together.</p>

<p>Each category can have a key assigned to it which has two functions:</p>
<ul>
	<li>Active the current tool in the category, if not already active.</li>
	<li>If the category is active then the next tool in the category will become active.</li>
</ul>


<p>Tool extenders can also register a list of commands with the framework via the extension point definition.  If this is done the Tool extender must also create a <b>IHandler</b> object (part of the eclipse command framework).  An instance of the handler will be created for each command and each time a command occurs it will be passed to the handler to be handled.</p>

<p>Extension point example:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-xml"><span class="code-tag">&lt;extension point=<span class="code-quote">"net.refractions.udig.project.ui.tool"</span>&gt;</span>
      &lt;category
            commandId=<span class="code-quote">"net.refractions.udig.tools.infoCommand"</span>
            id=<span class="code-quote">"net.refractions.udig.tool.category.info"</span>
            name=<span class="code-quote">"%info.tools.name"</span>/&gt;
    ...
<span class="code-tag">&lt;/extension&gt;</span></pre>
</div></div>

<h3><a name="06Tools-ActionSetconventionforToolCategory"></a>ActionSet convention for Tool Category</h3>

<p>We will check for an ActionSet with the same name as the ToolCategory - you can use this facility to turn off actions that don't make sense for your perspective.</p>

<h2><a name="06Tools-ToolCursorExtension"></a>Tool Cursor Extension</h2>

<p>Cursors can be defined independently from tools; allowing you to reuse the same cursor for several tools.</p>

<p>Extension example:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-xml"><span class="code-tag">&lt;extension point=<span class="code-quote">"net.refractions.udig.project.ui.tool"</span>&gt;</span>
    &lt;toolCursor
        hotspotX=<span class="code-quote">"10"</span>
        hotspotY=<span class="code-quote">"10"</span>
        id=<span class="code-quote">"arrowCursor"</span>
        image=<span class="code-quote">"icons/pointers/edit_source.gif"</span>/&gt;
    ...
<span class="code-tag">&lt;/extension&gt;</span></pre>
</div></div>

<p>Where:</p>
<ul>
	<li><em>id</em> is an unique ID of the cursor to be accessed from any place of UDIG platform to get cursor image.</li>
	<li><em>image</em> path to cursor image inside of plugin</li>
	<li><em>hotspotX, hotspotY</em> coordinates from top left corner of hot point for the cursor.</li>
</ul>


<p>Once the tool cursor is defined as an extension it is accessible as a default tool cursor by <b>toolCursorId</b> attribute of a modal tool element. For this to work the ID must be unqiue &#8211; allowing a cursor defined in one plug-in to used by the tool from another plug-in just by ID.</p>

<h1><a name="06Tools-ToolImplementationandFramework"></a>Tool Implementation and Framework</h1>

<h2><a name="06Tools-ToolManager"></a>ToolManager </h2>

<p>The <b>ToolManager</b> is responsible for adding tools to the menu bar and tool bar. To add tool buttons to custom views the ToolManager.createToolAction(ToolID, CategoryID) method will create an <b>Action</b> that can be added to the view.</p>

<h2><a name="06Tools-ToolContext"></a>ToolContext</h2>

<p>All Tools are provided with a ToolContext object by the framework.  The tools can use the context to access the model and to create and send commands which modify the model.  Contexts have a large number of methods to simplify the job of tool authors.  Please let us know of methods that would be useful or should be part of the context objects.</p>

<p><b>IMPORTANT</b>:  It is critical that the tools do not make a new reference to the context object because it is set each time the editor is activated and may change without notification.</p>

<h2><a name="06Tools-ToolImplementation"></a>Tool Implementation</h2>

<p>There are several abstract classes available for you to extend.</p>

<p><img src="download/attachments/178/toolframework.GIF" align="absmiddle" border="0"/></p>

<p>There are several available subclasses to start you out:</p>
<ul>
	<li>AbstractActionTool</li>
	<li>AbstractTool</li>
	<li>AbstractModelTool</li>
	<li>SimpleTool: an implementation of ModalTool with support for a right-click context menu, it serves as a great starting place for creating your own tool that involves "selecting a location" or "selecting content" on the map and making a range of actions available.</li>
</ul>


<p>Note when using <b>AbstractTool</b> you can use the constructor to define what sort of events you are interested in, the events come in already expressed in Map coordinates.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">class ExampleTool AbstractTool(){
    ExampleTool(){
       <span class="code-keyword">super</span>( MOUSE | WHEEL );
    }
    <span class="code-keyword">public</span> void mouseReleased( MapMouseEvent e ) {
       ...
    }
    <span class="code-keyword">public</span> void mouseWheelMoved( MapMouseWheelEvent e ) {
       ...
    } 
}</pre>
</div></div>

<h3><a name="06Tools-ToolLifecycle"></a>Tool Lifecycle</h3>

<p>Tools go through a fixed lifecycle:</p>
<ul>
	<li>Extension XML definition processed, the result is held by a ToolProxy until actually needed</li>
	<li>Default "no argument" constructor is called</li>
	<li>AbstractTool.init(IConfigurationElement) is called allows the tool to configure itself based on the XML definition</li>
	<li>Tool.setContext called each time an Editor is activated</li>
	<li>Tool.addListener / removeListener called as needed</li>
	<li>Tool.setEnabled is called as needed</li>
	<li>ModalTool.setActive is called as needed</li>
	<li>Tool.dispose()</li>
</ul>


<h3><a name="06Tools-ToolActivation"></a>Tool Activation</h3>

<p>Tool activation is a life cycle step reserved for ModalTools; when active a modal tool will control what the Map Editor is doing - the tools cursor will be displayed, its selection will be treated as the MapEditor selection as far as the work bench is concerned.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">ModalTool.<span class="code-object">boolean</span> isActive()
ModalTool.setActive( <span class="code-object">boolean</span> )
ModalTool.getCursorID()
ModalTool.setCursorID( <span class="code-object">String</span> )
ModalTool.getSelectionProvider()
ModalTool.setSelectionProvider(IMapEditorSelectionProvider)</pre>
</div></div>

<p>Only one modal tool can be active. There is no other opportunity to activate another disabled tool through UI contributions. When the tool is disabled, its UI contributions are disabled.</p>

<p>When the active tool is being disabled, its functionality is blocked but the tool is still active. The tool can be enabled by changing of context again. In that case only user manually can switch to any other enabled tool through UI contributions.  </p>

<h3><a name="06Tools-ToolEnablement"></a>Tool Enablement</h3>

<p>The tool interface has two methods to track isEnabled:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">Tool.setEnabled(<span class="code-object">Boolean</span>)
Tool.isEnabled()</pre>
</div></div>

<p>This lets to enable/disable a tools functionality at any time during tool life cycle. When the tool is disabled, the cursor for the MapEditor is changed initialized and the functionality is blocked by unregistering mouse listeners.</p>

<p>There are several ways to perform tool enablement. First way is to let the system performs enablement on the base of current context (selecting different layers, etc.). The second wayis to manually calling <em>Tool.setEnabled(Boolean)</em> from any place of tool implementation to simply block its functionality.</p>

<h3><a name="06Tools-ToolLifecycleListeners"></a>Tool Lifecycle Listeners</h3>

<p>I started tool lifecycle listeners: the initial three events are:</p>
<ul>
	<li>tool activation (only one modal item can be active at any time).</li>
	<li>tool enablement (can be performed at any time)</li>
	<li>context changing (during changing of context the tool also can be enabled or disabled automatically)</li>
</ul>


<p>Tool lifecycle listeners are not used anywhere at the current moment, but it would be good to have such functionality to listen tools lifecycle events without overriding of Tool class methods.</p>

<h2><a name="06Tools-ToolCursorImplementation"></a>Tool Cursor Implementation</h2>

<p>Cursor is a disposable object and to implement lazy loading the proxy object is used in the same manner as <em>ToolProxy</em> object before:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">net.refractions.udig.project.ui.internal.tool.display.CursorProxy</pre>
</div></div>
<p>ToolManager is responsible to create full list of cursor proxies and cache them by ID from extension point. Whenever the actual <em>org.eclipse.swt.graphics.Cursor</em> object is needed you must call the following method:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">Cursor IToolManager.findToolCursor(<span class="code-object">String</span> cursorID);</pre>
</div></div>
<p>In most cases the developer does not need the org.eclipse.swt.graphics.Cursor object while working with tools implementation. The Tools API is extended by the next methods to manage tool cursors:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">ModalTool.setCursorID(<span class="code-object">String</span> cursorID)
<span class="code-object">String</span> ModalTool.getCursorID()</pre>
</div></div>
<p>These methods are responsible for the cursors management. The set method performs actual updating of mouse cursor image if it is needed.</p>

<h3><a name="06Tools-UsingDefaultSystemCursors"></a>Using Default System Cursors</h3>

<p>Systems cursors are listed using constants in SWT class. Constants are integer numbers. While current Tool Cursors Framework uses string IDs it is recommended to work with mapped constants from ModalTool interface. These constants are mapped to system cursors. If the system cursor <em>SWT.CURSOR_WAIT</em> is needed then call routine:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">ModalTool.setCursorID(ModalTool.WAIT_CURSOR);</pre>
</div></div>

<p>In this case the framework recognizes that the system cursor is requested and sets it for the tool. You can combine as custom cursors as system using the underlying mechanism transparently.</p>

<h3><a name="06Tools-FindingaCursoratRuntime"></a>Finding a Cursor at Runtime</h3>

<p>The developer can declaratively add cursor images through extension mechanism and use them by ID from any place in source code. If the SWT object is needed call:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">IToolManager.findToolCursor(<span class="code-object">String</span> cursorID).</pre>
</div></div>

<p>If you just want to set cursor for the tool just call</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">ModalTool.setCursorID(<span class="code-object">String</span> cursorID).</pre>
</div></div>

<p>Updating of mouse cursor image is performed automatically by the framework depending on the current context, active tool, etc.</p>

<h3><a name="06Tools-Compatibility"></a>Compatibility</h3>

<p>It is possible to support compatibility with cursor extension point under tool extension point as a default cursor for the tool.</p>

<h1><a name="06Tools-FutureDirection"></a>Future Direction</h1>

<p>Currently all tools are active but in the future would be desirable to have a tool configuration extension point where udig extenders can define which tools are activated for their application.  A system like the eclipse command framework for Eclipse 3.1 is likely.</p>

<p>This work has been started already by making use of ActionSets and Tool Categories.</p>

<small>
  (c) Copyright (c) 2004-2008 Refractions Research Inc. and others.<br>
  <a href="http://udig.refractions.net/confluence/pages/viewpage.action?pageId=178">[wiki]</a>
</small>
    </body>
</html>