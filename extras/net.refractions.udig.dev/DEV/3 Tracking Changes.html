<html>
    <head>
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="../book.css" type="text/css" />
        <title>UDIG Developer Guide : 3 Tracking Changes</title>
    </head>
    <body BGCOLOR="#FFFFFF">
       <!-- UDIG Developer Guide : 3 Tracking Changes -->
       <h1>3 Tracking Changes</h1>

       <p>What if you want to keep track of all of the changes to the catalog that happen while your plug-in is running? You can register an IResolveChangeListener with the catalog plugin. Your listener will be notified of the changes via an IResolveChangeEvent object, which describes the changes.</p>

<div class='panelMacro'><table class='tipMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/check.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>
<p>If you are an proficient eclipse developer you can consider IResolve as similar to the IResource api provided by eclipse. There is a difference in blocking behavior, as resolve explicitly represents a handle to a remote resource or service.</p>

<p>Have a look at the article below; you may find it better written than what we have here (both systems use the same design).</p>
  <img src="http://udig.refractions.net/image/DEV/ngrelr.gif">

<p><a href="http://www.eclipse.org/articles/Article-Resource-deltas/resource-deltas.html">How You've Changed!</a></p></td></tr></table></div>

<h3><a name="3TrackingChanges-Registeringalistener"></a>Registering a listener </h3>

<p>First, you must register a resource change listener with the catalog plugin. </p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">IResolveChangeListener listener = <span class="code-keyword">new</span> MyResolveChangeReporter();
   CataqlogPlugin.addResourceChangeListener( listener );</pre>
</div></div>
<p>Your listener will be notified after modifications to the resources have been made. Catalog API methods that modify resources trigger these events as part of their documented behavior. The method comment for a Catalog API method explicitly states whether or not it triggers a resource change event.</p>

<p>For example, the following is included in the IService.getInfo() comment: </p>

<div class="panel" style="border-width: 1px;"><div class="panelContent">
<p>When new information is available changes will be reported in a change event, including an indication that this service's contents have been changed.</p>
</div></div>

<p>Most catalog resources trigger these events the first time the handle is used. Methods that create, delete, or change a resource typically trigger these events on every use.</p>

<h3><a name="3TrackingChanges-Resolvechangeevents"></a>Resolve change events</h3>

<p>The resolve change event describes the specifics of the change that have occurred in the catalog. The event contains a "delta" that describes the net effect of the changes.</p>

<p>The resolve delta is structured as a tree rooted at the catalog. The resolve delta tree describes these types of changes:</p>

<ul>
	<li>Resources that have been created, deleted, or changed. If you have deleted (or added) a Web Map Server, the resource delta will include the Web Map Server and all Layers provided by that service.</li>
</ul>


<ul>
	<li>Resources that have been replaced replaced.</li>
</ul>


<p>To traverse a resolve delta tree, you may implement the IResolveDeltaVisitor interface or traverse the tree explicitly using IResource.getChildren. Resolve delta visitors implement a visit method that is called by the resource delta as it enumerates each change in the tree.</p>

<p>The types of resource change events and when they are reported.</p>

<ul>
	<li>PRE_CLOSE<br clear="all" /> Notifies listeners that resolve is about to be closed. This event can be used to save necessary information from the in-memory representation (e.g., session properties) before it is closed.</li>
</ul>


<ul>
	<li>PRE_DELETE<br clear="all" /> Notifies listeners that a project is about to be deleted. This event can be used to perform clean-up operations, such as removing any saved state that is related to the resolve.</li>
</ul>


<ul>
	<li>POST_CHANGE <br clear="all" /> Describes a set of changes that have occured to the workspace since the last POST_CHANGE event was reported. Triggered after the catalog API is used. The event contains a resource delta describing the net changes since the last POST_CHANGE event.</li>
</ul>


<h3><a name="3TrackingChanges-Implementingaresolvechangelistener"></a>Implementing a resolve change listener</h3>

<p>The following example implements a console-based resolve change listener. A resolve change listener is registered for events and information about these events is printed to the console: </p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">IResolveChangeListener listener = <span class="code-keyword">new</span> MyResolveChangeReporter();
   CatalogPlugin.addListener(listener);</pre>
</div></div>
<p>The listener checks for each event type and reports information about the resolve that was changed and the kinds of changes that occurred.  </p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">import</span> org.eclipse.resources.*;
   <span class="code-keyword">import</span> org.eclipse.runtime.*;
   <span class="code-keyword">static</span> <span class="code-keyword">import</span> 
   <span class="code-keyword">public</span> class MyResolveChangeReporter <span class="code-keyword">implements</span> IResolveChangeListener {
      <span class="code-keyword">public</span> void changed(IResolveChangeEvent event) {
         IResolve res = event.getResolve();
         <span class="code-keyword">switch</span> (event.getType()) {
            <span class="code-keyword">case</span> IResolveChangeEvent.PRE_CLOSE:
               <span class="code-object">System</span>.out.print(res.getIdentifier());
               <span class="code-object">System</span>.out.println(<span class="code-quote">" is about to close."</span>);
               <span class="code-keyword">break</span>;
            <span class="code-keyword">case</span> IResolveChangeEvent.PRE_DELETE:
               <span class="code-object">System</span>.out.print(res.getFullPath());
               <span class="code-object">System</span>.out.println(<span class="code-quote">" is about to be deleted."</span>);
               <span class="code-keyword">break</span>;
            <span class="code-keyword">case</span> IResolveChangeEvent.POST_CHANGE:
               <span class="code-object">System</span>.out.println(<span class="code-quote">"Resources have changed."</span>);
               event.getDelta().accept(<span class="code-keyword">new</span> DeltaPrinter());
               <span class="code-keyword">break</span>;
         }
      }
   }</pre>
</div></div>

<p>The DeltaPrinter class implements the IResolveDeltaVisitor interface to interrogate the resolve delta. The visit() method is called for each resolve change in the resolve delta. The visitor uses a return value to indicate whether deltas for children should be visited.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">class DeltaPrinter <span class="code-keyword">implements</span> IResolveDeltaVisitor {
      <span class="code-keyword">public</span> <span class="code-object">boolean</span> visit(IResourceDelta delta) {
         IResource res = delta.getResource();
         IResource old = delta.getOldResource();
         <span class="code-keyword">switch</span> (delta.getKind()) {
            <span class="code-keyword">case</span> IResolveDelta.Kind.ADDED:
               <span class="code-object">System</span>.out.print(<span class="code-quote">"Resource "</span>);
               <span class="code-object">System</span>.out.print(res.getIdentifier());
               <span class="code-object">System</span>.out.println(<span class="code-quote">" was added."</span>);
               <span class="code-keyword">break</span>;
            <span class="code-keyword">case</span> IResolveDelta.Kind.REMOVED"
               <span class="code-object">System</span>.out.print(<span class="code-quote">"Resource "</span>);
               <span class="code-object">System</span>.out.print(res.getIdentifier());
               <span class="code-object">System</span>.out.println(<span class="code-quote">" was removed."</span>);
               <span class="code-keyword">break</span>;
            <span class="code-keyword">case</span> IResolveDelta.Kind.CHANGED:
               <span class="code-object">System</span>.out.print(<span class="code-quote">"Resource "</span>);
               <span class="code-object">System</span>.out.print(res.getIdentifier());
               <span class="code-object">System</span>.out.println(<span class="code-quote">" has changed."</span>);
               <span class="code-keyword">break</span>;
            <span class="code-keyword">case</span> IResolveDelta.Kind.REPLACED:
               <span class="code-object">System</span>.out.print(<span class="code-quote">"Resource "</span>);
               <span class="code-object">System</span>.out.print(res.getIdentifier());
               <span class="code-object">System</span>.out.print(<span class="code-quote">" is replaced by "</span>);
               <span class="code-object">System</span>.out.print(res.getNewIdentifier().getIdentifier());
               <span class="code-keyword">break</span>;
         }
         <span class="code-keyword">return</span> <span class="code-keyword">true</span>; <span class="code-comment">// visit the children
</span>      }
   }</pre>
</div></div>

<p>For a complete description of resolve deltas, visitors, consult the API specification for IResolveDelta and IResolveDeltaVisitor.</p>

<p>Note:  Resolve change listeners are useful for tracking changes that occur to resources while your plug-in is activated. If your plug-in registers a listener during its startup code, it's possible that many resolve change events have been triggered before the activation of your plug-in.</p>

<p>Note:  Note most change events are triggered during processing that occurs in a background thread. Resolve change listeners should be thread-safe.</p>


<small>
  (c) Copyright (c) 2004-2008 Refractions Research Inc. and others.<br>
  <a href="http://udig.refractions.net/confluence/pages/viewpage.action?pageId=3395">[wiki]</a>
</small>
    </body>
</html>